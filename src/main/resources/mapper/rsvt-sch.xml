<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pharm.chorok.web.main.repository.ReservationScheduleRepository">

	<select id="selectSameWeekDateListByDt" parameterType="map" resultType="com.pharm.chorok.domain.table.TbCommCalendar">
	<![CDATA[    
	SELECT BASE_DT
		 , DAYS_STR_KOR
		 , DATE_FORMAT( BASE_DT, '%m-%d') AS BASE_DT_STR 
		 , DAYS_NUM
	  FROM TB_COMM_CALENDAR CAL
  	 WHERE CAL.WK_NUM = (SELECT WK_NUM 
	                       FROM TB_COMM_CALENDAR 
						  WHERE BASE_DT_STR = #{baseDtStr}
						)
	   AND DAYS_NUM > 1
     ORDER
		BY BASE_DT
	]]>
	</select>
	
	
	<select id="selectDateAdd" parameterType="map" resultType="com.pharm.chorok.domain.table.TbCommCalendar">
	<![CDATA[    
	SELECT *
      FROM TB_COMM_CALENDAR
     WHERE base_dt = date_add( STR_TO_DATE( #{cal.baseDtStr}, '%Y%m%d'), interval #{interval} DAY)
	]]>  
	</select>

	<select id="selectRsvtSchByWeek" 
		parameterType="map" 
		resultType="com.pharm.chorok.domain.table.TbPpRsvtSch">
	<![CDATA[	
	/** com.pharm.chorok.web.main.repository.ReservationScheduleRepository.selectRsvtSchByWeek */
    SELECT WT.ID                  AS "wt.id"
         , WT.START_HM            AS "wt.startHm"
         , WT.END_HM              AS "wt.endHm"
         , SCH.ID                 
         , SCH.RSVT_DT            
         , SCH.RSVT_USR_NM
         , CASE LENGTH(RSVT_CELL_NO)
                WHEN 11 THEN CONCAT(LEFT(RSVT_CELL_NO, 3), '-', MID('***********', 4, 4), '-', RIGHT(RSVT_CELL_NO, 4))
                WHEN 10 THEN CONCAT(LEFT(RSVT_CELL_NO, 3), '-', MID('**********' , 4, 3), '-', RIGHT(RSVT_CELL_NO, 4))
           END AS RSVT_CELL_NO
         , SCH.DAYS_NUM           AS "cal.daysNum"
      FROM TB_PP_WORK_TIME WT
    INNER JOIN
        (
        SELECT ID
                , DATE_FORMAT(RSVT_DT, '%H%i%s') AS RSVT_HM
                , RSVT_DT
                , RSVT_USR_NM
                , RSVT_CELL_NO
                , CAL.DAYS_NUM
                , CAL.DAYS_STR_KOR
            FROM TB_PP_RSVT_SCH
            INNER JOIN 
                TB_COMM_CALENDAR CAL
            ON DATE_FORMAT(RSVT_DT, '%Y%m%d') = CAL.BASE_DT
            WHERE CAL.WK_NUM = (SELECT WK_NUM 
								  FROM TB_COMM_CALENDAR 
								 WHERE BASE_DT_STR = #{baseDtStr}
								)
            AND CAL.DAYS_NUM > 1
        ) SCH
        ON WT.START_HM <= STR_TO_DATE(SCH.RSVT_HM, '%H%i%s')
    AND WT.END_HM   >= STR_TO_DATE(SCH.RSVT_HM, '%H%i%s')
    WHERE 1 = 1
    ORDER
        BY WT.START_HM
        , SCH.RSVT_DT
	]]>
	</select>


	<select id="selectWorkTime" resultType="com.pharm.chorok.domain.table.TbPpWorkTime">
	<![CDATA[
	/** com.pharm.chorok.web.main.repository.ReservationScheduleRepository.selectWorkTime */
    SELECT WT.WORK_VER
         , WT.ID
         , WT.START_HM
         , WT.END_HM
      FROM TB_PP_WORK_TIME WT
     WHERE WT.USE_YN = 'Y'
     ORDER
        BY WT.START_HM
	]]>
	</select>
	
	
	<select id="findReservationInfoByRsvtId" 
		parameterType="com.pharm.chorok.domain.table.TbPpRsvtSch" 
		resultType="com.pharm.chorok.domain.table.TbPpRsvtSch">
	<![CDATA[
	/** com.pharm.chorok.web.main.repository.ReservationScheduleRepository.findReservationInfoByRsvtId */
	SELECT ID
	     , RSVT_USR_NM
         , RSVT_CELL_NO
	     , RSVT_PHN_NO
	     , RSVT_DT
	     , RSVT_TP_CD
	     , GEN_TP_CD
	     , RSVT_DESC
	  FROM TB_PP_RSVT_SCH SCH
	 WHERE ID = #{id}
	]]>
	</select>
	
	
	<select id="findReservationTimeList"  
		resultType="com.pharm.chorok.domain.table.TbPpWorkTime">
	<![CDATA[
	/** com.pharm.chorok.web.main.repository.ReservationScheduleRepository.findReservationTimeList */
	SELECT DISTINCT
           STR_TO_DATE(CONCAT(DATE_FORMAT( WT.START_HM, '%H'), RPAD(TMP.N, 2, '0')), '%H%i') AS startHm
      FROM TB_PP_WORK_TIME WT
     CROSS JOIN
           t TMP
        ON N < 6
     WHERE WT.USE_YN = 'Y'
	]]>
	</select>
	
	
	<insert id="insertTbPpRsvtSch" parameterType="com.pharm.chorok.domain.table.TbPpRsvtSch">
	<![CDATA[
	INSERT INTO TB_PP_RSVT_SCH (
	     RSVT_USR_NM
	   , RSVT_DT
	   , RSVT_CELL_NO
	   , RSVT_PHN_NO
	   , RSVT_TP_CD
	   , RSVT_DESC
	   , GEN_TP_CD
	   , RCMD_USR_NO
	   , PIC_USR_NO
	   , REG_DT
	   , REG_USR_NO
	) VALUES (
	     #{rsvtUsrNm}
	   , STR_TO_DATE( #{rsvtDt}, '%Y-%m-%d %H:%i:%s')
	   , #{rsvtCellNo}
	   , #{rsvtPhnNo}
	   , #{rsvtTpCd}
	   , #{rsvtDesc}
	   , #{genTpCd}
	   , #{rcmdUsrNo}
	   , #{picUsrNo}
	   , now()
	   , #{regUsrNo}
	)
	]]>
	</insert>
	
	<update id="updateTbPpRsvtSch" parameterType="com.pharm.chorok.domain.table.TbPpRsvtSch">
	<![CDATA[
	UPDATE TB_PP_RSVT_SCH
	   SET UPD_DT        = now()
		 , UPD_USR_NO    = #{updUsrNo}
		 , RSVT_USR_NM   = #{rsvtUsrNm} 
		 , RSVT_DT       = STR_TO_DATE( #{rsvtDt}, '%Y-%m-%d %H:%i:%s')
		 , RSVT_CELL_NO  = #{rsvtCellNo} 
		 , RSVT_PHN_NO   = #{rsvtPhnNo} 
		 , RSVT_TP_CD    = #{rsvtTpCd} 
		 , RSVT_DESC     = #{rsvtDesc} 
		 , GEN_TP_CD     = #{genTpCd} 
		 , RCMD_USR_NO   = #{rcmdUsrNo} 
	     , PIC_USR_NO    = #{picUsrNo}
     WHERE ID = #{id}	 
	]]>
	</update>
	
	<update id="deleteTbPpRsvtSch" parameterType="com.pharm.chorok.domain.table.TbPpRsvtSch">
	<![CDATA[
	DELETE FROM TB_PP_RSVT_SCH
     WHERE ID = #{id}	 
	]]>
	</update>
	
</mapper>