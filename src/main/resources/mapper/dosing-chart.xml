<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pharm.chorok.web.main.repository.DosingRepository">

    <select id="selectDosingChartByCnstId"  parameterType="com.pharm.chorok.domain.table.TbPpCnstChart" resultType="com.pharm.chorok.domain.main.ResultDosingVo">
	<![CDATA[    
	/** com.pharm.chorok.web.main.repository.DosingRepository.selectDosingChartByCnstId */
	/** 차트번호에 대한 차트마스터 정보 조회 */
    SELECT @ROWNUM := @ROWNUM + 1 AS SEQ
         , CONCAT(@ROWNUM, '일차') AS SEQ_STR
         , DOSG_ID
         , CNST_ID
         , DATE_FORMAT(DOSG_DT, '%Y-%m-%d') AS DOSG_DT
         , (SELECT DAYS_STR_KOR FROM TB_COMM_CALENDAR CAL WHERE CAL.BASE_DT_STR = DATE_FORMAT(DOSG_DT, '%Y%m%d')) AS DAYS_STR_KOR
         , DOSG_TP_CD
         , CALL_YN          
         , DOSG_YN
         , PAUS_YN          
         , CURR_WGT    
         , LOSS_WGT     
         , RMI_WGT
         , DOSG_DESC1       
         , DOSG_DESC2       
         , REG_DT           
         , REG_USR_NO
      FROM TB_PP_DOSG_CHART DOSG
         , (SELECT @ROWNUM :=-1) TMP
     WHERE CNST_ID = #{cnstId}
     ORDER
        BY DOSG_ID
	]]>
    </select>

    <select id="selectDosingChartByCallYn"  parameterType="com.pharm.chorok.domain.table.TbPpCnstChart" resultType="com.pharm.chorok.domain.main.ResultDosingVo">
	<![CDATA[    
	/** com.pharm.chorok.web.main.repository.DosingRepository.selectDosingChartByCallYn */
	/** 차트번호에 대한 차트마스터 정보 조회 */
    SELECT @ROWNUM := @ROWNUM + 1 AS SEQ
         , CONCAT(@ROWNUM, '일차') AS SEQ_STR
         , DOSG_ID
         , CNST_ID
         , DATE_FORMAT(DOSG_DT, '%Y-%m-%d') AS DOSG_DT
         , (SELECT DAYS_STR_KOR FROM TB_COMM_CALENDAR CAL WHERE CAL.BASE_DT_STR = DATE_FORMAT(DOSG_DT, '%Y%m%d')) AS DAYS_STR_KOR
         , DOSG_TP_CD
         , CALL_YN          
         , DOSG_YN
         , PAUS_YN          
         , CURR_WGT    
         , LOSS_WGT     
         , RMI_WGT
         , DOSG_DESC1       
         , DOSG_DESC2       
         , REG_DT           
         , REG_USR_NO
      FROM TB_PP_DOSG_CHART DOSG
         , (SELECT @ROWNUM :=-1) TMP
     WHERE CALL_YN = 'Y'
     ORDER
        BY DOSG_ID
	]]>
    </select>

    <select id="selectDashDosingList01"  resultType="com.pharm.chorok.domain.main.ResultDashBoard01VO">
	<![CDATA[    
    SELECT C.CUST_USR_NM
         , C.CUST_CELL_NO
         , C.ADDR1
      FROM bazzarmall.TB_PP_DOSG_CHART A
         , bazzarmall.TB_PP_CNST_CHART B
         , bazzarmall.TB_CUSTOMER C
     WHERE A.CNST_ID = B.CNST_ID
       AND B.CUST_ID = C.CUST_ID
       AND DOSG_DT = DATE_FORMAT(NOW(), '%Y%m%d')
	]]>
    </select>

    <select id="selectDashDosingList02"  resultType="com.pharm.chorok.domain.main.ResultDashBoard01VO">
	<![CDATA[    
    SELECT C.CUST_USR_NM
         , C.CUST_CELL_NO
         , C.ADDR1
      FROM bazzarmall.TB_PP_DOSG_CHART A
         , bazzarmall.TB_PP_CNST_CHART B
         , bazzarmall.TB_CUSTOMER C
     WHERE A.CNST_ID = B.CNST_ID
       AND B.CUST_ID = C.CUST_ID
       AND DOSG_DT = DATE_FORMAT(NOW(), '%Y%m%d')
	]]>
    </select>

    <select id="selectDashDosingList03"  resultType="com.pharm.chorok.domain.main.ResultDashBoard01VO">
	<![CDATA[    
    SELECT B.CNST_ID
         , C.CUST_USR_NM
         , C.CUST_CELL_NO
         , MAX(ABS(DATEDIFF(  dosg_dt, DATE_FORMAT(NOW(), '%Y%m%d')))) AS PASS_DAYS
         , MAX(STR_TO_DATE(DOSG_DT, '%Y%m%d')) as LAST_DOSG_DT
	  FROM bazzarmall.TB_PP_DOSG_CHART A
         , bazzarmall.TB_PP_CNST_CHART B
         , bazzarmall.TB_CUSTOMER C
     WHERE A.CNST_ID = B.CNST_ID
       AND B.CUST_ID = C.CUST_ID
       -- AND A.PAUS_YN = 'Y'
	 GROUP
        BY B.CNST_ID
         , C.CUST_USR_NM
         , C.CUST_CELL_NO
	]]>
    </select>


    <insert id="insertTbPpDosgChart" parameterType="com.pharm.chorok.domain.table.TbPpCnstChart">
	<![CDATA[    
    INSERT INTO TB_PP_DOSG_CHART (
          CNST_ID
        , DOSG_DT
        , DOSG_TP_CD
        , CALL_YN
        , REG_DT
        , REG_USR_NO
    ) 
    SELECT #{cnstId}
         , BASE_DT_STR
         , DOSG_TP_CD
         , 'N'
         , now()
         , #{regUsrNo}
      FROM (
            SELECT A.ROWNUM
                 , CASE WHEN ROWNUM  = 0  THEN  '0'
                        WHEN ROWNUM  <= 3  THEN '1'
                        WHEN ROWNUM  <= 7  THEN '2'
                        WHEN ROWNUM  <= 14 THEN '3'
                        WHEN ROWNUM  <= 21 THEN '4'
                        WHEN ROWNUM  <= 28 THEN '5'
                END AS DOSG_TP_CD
                , A.BASE_DT_STR
            FROM (
                SELECT CAL.*
                        , @ROWNUM := @ROWNUM + 1 AS ROWNUM
                    FROM bazzarmall.TB_COMM_CALENDAR CAL
                        , (SELECT @ROWNUM :=-1) TMP
                        , (SELECT STR_TO_DATE( #{startDosgDt}, '%Y-%m-%d') AS START_DOSING_DT) T
                    WHERE 1 = 1
                    AND BASE_DT_STR >= DATE_FORMAT( DATE_ADD( T.START_DOSING_DT, INTERVAL -1 DAY), '%Y%m%d')
                    AND BASE_DT_STR < DATE_ADD( T.START_DOSING_DT, INTERVAL 27 DAY)
                ) A
            ORDER
                BY A.ROWNUM
            ) A
	]]>
	</insert>

    <delete id="deleteTbPpDosgChart" parameterType="com.pharm.chorok.domain.table.TbPpCnstChart">
	<![CDATA[    
    DELETE FROM TB_PP_DOSG_CHART
     WHERE CNST_ID = #{cnstId}
	]]>
	</delete>

    <update id="updateTbPpDosgChart" parameterType="com.pharm.chorok.domain.table.TbPpDosgChart">
	<![CDATA[    
    UPDATE TB_PP_DOSG_CHART 
       SET DOSG_DT     = DATE_FORMAT(#{dosgDt}, '%Y%m%d')
         , DOSG_TP_CD  = #{dosgTpCd}
         , CALL_YN     = #{callYn}
         , DOSG_YN     = #{dosgYn}
         , PAUS_YN     = #{pausYn}
         , CURR_WGT    = #{currWgt} 
         , LOSS_WGT    = #{lossWgt}
         , RMI_WGT     = #{rmiWgt}
         , DOSG_DESC1  = #{dosgDesc1} 
         , DOSG_DESC2  = #{dosgDesc2} 
     WHERE DOSG_ID     = #{dosgId}
	]]>
	</update>
</mapper>